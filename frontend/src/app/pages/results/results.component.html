<app-navbar></app-navbar>

<div class="container mt-4">
  <app-last-executions></app-last-executions>
  <br />
  <div class="card mb-4">
    <div class="card-header custom-header">
      <b>Task {{ selectedTask.runName ? '#' + selectedTask.runName : 'N/A' }}</b>
    </div>

    <div class="card-body">
      <div *ngIf="selectedTask && selectedTask.runName">
        <!-- Parameters Section -->
        <div class="row mb-4">
          <div class="col-12 mb-3">
            <h5 class="fw-bold">Used Parameters in Task #{{ selectedTask.runName }}</h5>
          </div>

          <div class="col-md-6 mb-3" *ngIf="selectedTask.fasta">
            <p><strong>FASTA File:</strong> {{ selectedTask.fasta.name }}</p>
          </div>

          <div class="col-md-6 mb-3">
            <p><strong>Action:</strong> {{ selectedTask.action }}</p>
          </div>
          <div class="col-md-6 mb-3">
            <p><strong>BepiPred Threshold:</strong> {{ selectedTask.bepipredThreshold }}</p>
          </div>

          <div class="col-md-6 mb-3">
            <p><strong>Min Epitope Length:</strong> {{ selectedTask.minEpitopeLength }}</p>
          </div>
          <div class="col-md-6 mb-3">
            <p><strong>Max Epitope Length:</strong> {{ selectedTask.maxEpitopeLength }}</p>
          </div>

          <div class="col-md-6 mb-3">
            <p><strong>Subcellular Localization:</strong> {{ selectedTask.subcell }}</p>
          </div>
          <div class="col-md-6 mb-3">
            <p><strong>InterPro:</strong> {{ selectedTask.interpro }}</p>
          </div>
        </div>

        <!-- Epitopes Summary and Search -->
        <div class="row align-items-center mb-3">
          <div class="col-md-6">
            <h5 class="mb-0">Epitopes Found: {{ epitopes.length }}</h5>
          </div>
          <div class="col-md-6 text-end">
            <input
              type="text"
              [(ngModel)]="filterText"
              placeholder="Search..."
              (input)="applyFilters()"
              class="form-control w-75 float-end"
              aria-label="Search epitopes"
            />
          </div>
        </div>
      </div>

      <!-- Table -->
      <div class="table-responsive">
        <table class="table table-striped table-hover table-bordered">
          <thead class="table-light">
            <tr>
              <th *ngFor="let column of columns" (click)="sort(column.key)" class="text-center" style="cursor: pointer;">
                {{ column.label }}
                <span *ngIf="sortColumn === column.key">
                  {{ sortDirection === 'asc' ? '▲' : '▼' }}
                </span>
              </th>
            </tr>
          </thead>
          <tbody>
            <tr *ngIf="epitopes.length === 0">
              <td class="text-center text-muted" [attr.colspan]="columns.length">
                No data available
              </td>
            </tr>
            <tr
              *ngFor="let epitope of epitopes; let i = index"
              (click)="selectEpitope(epitope)"
              style="cursor: pointer;"
            >
              <td class="text-center">{{ epitope.id }}</td>
              <td class="text-center" style="font-family: 'Courier New', Courier, monospace;">
                <ng-container *ngIf="epitope.epitope">
                  <ng-container *ngIf="epitope.epitope.length <= 10">
                    {{ epitope.epitope }}
                  </ng-container>
                  <ng-container *ngIf="epitope.epitope.length > 10">
                    <ng-container *ngIf="expandedEpitopeIndex !== i">
                      {{ epitope.epitope | slice : 0 : 10 }}...
                      <i
                        class="fa-solid fa-eye ms-1"
                        style="color: #6aa5d9; cursor: pointer;"
                        (click)="toggleEpitope(i); $event.stopPropagation();"
                        title="Show full epitope"
                      ></i>
                    </ng-container>
                    <ng-container *ngIf="expandedEpitopeIndex === i">
                      {{ epitope.epitope }}
                      <i
                        class="fa-solid fa-eye-slash ms-1"
                        style="color: #d96a6a; cursor: pointer;"
                        (click)="toggleEpitope(i); $event.stopPropagation();"
                        title="Hide epitope"
                      ></i>
                    </ng-container>
                  </ng-container>
                </ng-container>
              </td>
              <td class="text-center">{{ epitope.start }}</td>
              <td class="text-center">{{ epitope.end }}</td>
              <td class="text-center">{{ epitope.length }}</td>
              <td class="text-center">{{ epitope.molecularWeight }}</td>
              <td class="text-center">{{ epitope.isoelectricPoint }}</td>
              <td class="text-center">{{ epitope.hydropathy }}</td>
              <td class="text-center">{{ epitope.bepiPred3 }}</td>
              <td class="text-center">{{ epitope.emini }}</td>
              <td class="text-center">{{ epitope.kolaskar }}</td>
              <td class="text-center">{{ epitope.chouFosman }}</td>
              <td class="text-center">{{ epitope.karplusSchulz }}</td>
              <td class="text-center">{{ epitope.parker }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="card-footer">
      <app-topology></app-topology>
    </div>
  </div>
</div>

<app-footer></app-footer>
